<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Taekwondo Jepara</title>
  <link rel="stylesheet" href="style.css" />

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>

<header>
  <div class="logo">TAEKWONDO JEPARA</div>
  <nav>
    <ul>
      <li><a href="#home">Home</a></li>
      <li><a href="#pendaftaran">Pendaftaran</a></li>
      <li><a href="#cetak">Cetak Bukti</a></li>
    </ul>
  </nav>
</header>

<main>

<section id="home" class="section">
  <h1>Selamat Datang di Taekwondo Jepara Championship</h1>
  <p>Bergabunglah bersama Taekwondo Jepara Championship.</p>
  <img src="logo.png" class="banner-img"/>
</section>

<section id="pendaftaran" class="section">
  <h2>Pendaftaran</h2>
  <p></p>
  <a href="https://docs.google.com/forms/d/e/1FAIpQLSfuBPDmHllEi3eJeWK2gwRFkGWDpS5voZ4JY532-eIx6aBy3A/viewform?usp=dialog" target="_blank" class="button">üìù Formulir Pendaftaran</a>
</section>

<section id="cetak" class="section">
  <h2>Cetak Bukti Pendaftaran</h2>
  <input type="text" id="cariNama" placeholder="Masukkan NAMA" class="input-text">
  <button class="button" onclick="cariDataPdf()">üîç Cari & Download PDF</button>
  <div id="hasilBukti" class="result-box"></div>
</section>

</main>

<footer>
  <p>&copy; 2025 Taekwondo Jepara</p>
</footer>

<!-- Hidden QR Generator -->
<div id="qr-temp" style="display:none;"></div>

<script>
const SHEET_ID = "2PACX-1vSk34I9eypoPBYoMVVShtYy41veefWRRfeiQwyIMl2ZskpU7u57oFioM1PaQe2TbcYPDbyvHEbCFAsp";
const SHEET_GID = "1274406652";

async function ambilDataSheet() {
    const url = `https://docs.google.com/spreadsheets/d/e/${SHEET_ID}/pub?gid=${SHEET_GID}&single=true&output=tsv`;
    const res = await fetch(url);
    const text = await res.text();
    return text.split("\n").map(r => r.split("\t"));
}

async function generatePDF(row, header) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const namaUrl = row[0].replace(/ /g, "_");
    const verifyUrl = `https://taekwondo-jepara.vercel.app/verifikasi?nama=${namaUrl}`;

    const qrDiv = document.getElementById("qr-temp");
    qrDiv.innerHTML = "";
    new QRCode(qrDiv, { text: verifyUrl, width: 180, height: 180, correctLevel: QRCode.CorrectLevel.H });
    await new Promise(res => setTimeout(res, 300));
    const qrImg = qrDiv.querySelector("img").src;

    doc.setFillColor(20,20,20);
    doc.rect(0,0,210,35,"F");
    doc.setFontSize(18);
    doc.setTextColor(241,196,15);
    doc.text("BUKTI PENDAFTARAN",105,15,{align:"center"});
    doc.setFontSize(12);
    doc.text("TAEKWONDO JEPARA",105,27,{align:"center"});

    doc.setDrawColor(241,196,15);
    doc.setLineWidth(1.5);
    doc.line(20,42,190,42);

    let y = 55;
    doc.setFontSize(12);
    for (let i=0;i<header.length;i++){
        doc.text(`${header[i]}`,20,y);
        doc.text(`: ${row[i]}`,60,y);
        y+=10;
    }

    doc.addImage(qrImg,"PNG",130,55,60,60);
    doc.setFontSize(10);
    doc.text("sudah terdaftar:",130,120);

    doc.setFontSize(10);
    doc.text("Dicetak otomatis oleh sistem Taekwondo Jepara",105,285,{align:"center"});

    return doc;
}

async function cariDataPdf() {
    const keyword = document.getElementById("cariNama").value.toLowerCase().trim();
    const box = document.getElementById("hasilBukti");
    if(!keyword) return alert("Masukkan NAMA");

    const data = await ambilDataSheet();
    const header = data[0];
    const list = data.slice(1);
    const match = list.find(r => r.join(" ").toLowerCase().includes(keyword));

    if(!match){
        box.innerHTML = "<b>Data tidak ditemukan.</b>";
        return;
    }

    let html = "<h3>Data Ditemukan</h3>";
    for(let i=0;i<header.length;i++){
        html += `<p><b>${header[i]}:</b> ${match[i]}</p>`;
    }
    box.innerHTML = html;

    const pdf = await generatePDF(match,header);
    const fileName = match[0].replace(/[^a-zA-Z0-9]/g,"_");
    pdf.save(`Bukti_Pendaftaran_${fileName}.pdf`);
}
</script>

</body>
</html>
